<!DOCTYPE html>
<html>

<head>
</head>

<body>
  <input id="inputFile" type="file" multiple>
  <canvas id="canvas"></canvas>
</body>
<script src='debug.js'></script>
<script>
  const cnv = document.getElementById('canvas');
  const ctx = cnv.getContext('2d');
  // Full 3x3 camera matrix: [fx, 0, cx, 0, fy, cy, 0, 0, 1]
  const K = new Float32Array([
    685.720, 0, 630.858,
    0, 685.636, 511.918,
    0, 0, 1
  ]);
  const lsd = new LSD.LSDVO(K, true, true);

  async function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    try {
      for (const file of files) {
        const img = await loadImage(file);
        processFrame(img);
      }
    } catch (err) {
      console.error("Error processing images:", err);
    }
  }

  function loadImage(file) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        URL.revokeObjectURL(img.src); // Prevent memory leak
        resolve(img);
      };
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  function processFrame(img) {
    // Resize canvas to half resolution
    const w = Math.floor(img.width / 2);
    const h = Math.floor(img.height / 2);
    cnv.width = w;
    cnv.height = h;

    // Draw and extract grayscale
    ctx.drawImage(img, 0, 0, w, h);
    const idata = ctx.getImageData(0, 0, w, h);
    const gray = getGray(idata.data, w, h);

    // Track frame
    console.time("Track");
    lsd.track(gray, w, h);
    console.timeEnd("Track");
  }

  function getGray(rgba, width, height) {
    const gray = new Array(width * height);
    for (let i = 0; i < rgba.length; i += 4) {
      gray[i >> 2] = rgba[i]; // Use red channel (or compute luminance)
    }
    return gray;
  }

  document.getElementById("inputFile").addEventListener("change", handleFileSelect);
</script>

</html>